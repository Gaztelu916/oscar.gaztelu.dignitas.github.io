<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DIGNITAS - Mapa de Fuentes de Agua</title>
  
  <!-- Estilos -->
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <link rel="stylesheet" href="./assets/css/mapa.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  
  <!-- ArcGIS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  
  <style>
    /* Estilos adicionales para el mapa */
    .map-container {
      position: relative;
      height: 600px;
      margin: 20px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    #infoPanel {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 99;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: 14px;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <div class="banner">
    <h1>DIGNITAS</h1>
    <div class="logo-container">
      <img src="./assets/images/cat-svgrepo-com.svg" alt="Logo DIGNITAS" width="50" height="50">
    </div>
  </div>

  <div class="main-content">
    <a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i> Volver al inicio</a>

    <div id="mapa" class="section">
      <h2>Mapa de Fuentes de Agua</h2>
      <p>Haz clic en cualquier punto del mapa para encontrar las fuentes de agua más cercanas (500m de radio).</p>

      <div class="map-container">
        <div id="infoPanel">Haz clic en el mapa para consultar fuentes de agua cercanas.</div>
        <div id="mapView"></div>
      </div>

      <p>Este mapa interactivo te ayuda a localizar las fuentes de agua públicas disponibles en la ciudad.</p>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 MAS MAYOR</p>
  </footer>

  <!-- Script de ArcGIS con funcionalidad de consulta -->
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/WebMap",
      "esri/geometry/Point",
      "esri/rest/support/Query",
      "esri/rest/query",
      "esri/Graphic"
    ], function(Map, MapView, WebMap, Point, Query, query, Graphic) {
      // Crear el WebMap utilizando el ID del elemento
      const webmap = new WebMap({
        portalItem: {
          id: "72164743029b49b2865b96c9aabd01b4"
        }
      });

      // Crear la vista del mapa
      const view = new MapView({
        container: "mapView",
        map: webmap
      });

      // Referencia al panel de información
      const infoPanel = document.getElementById("infoPanel");

      // Función para manejar clics en el mapa
      view.on("click", function(event) {
        // Obtener la ubicación del clic
        const point = event.mapPoint;

        // URL de la capa de fuentes de agua
        const layerUrl = "https://sigma.madrid.es/hosted/rest/services/MEDIO_AMBIENTE/FUENTES_DE_AGUA/MapServer/0";

        // Crear la consulta
        const queryParams = new Query({
          geometry: point,
          distance: 500, // Distancia en metros
          units: "meters",
          spatialRelationship: "intersects",
          returnGeometry: true,
          outFields: ["*"]
        });

        // Ejecutar la consulta
        query.executeQueryJSON(layerUrl, queryParams)
          .then(function(response) {
            // Limpiar gráficos anteriores
            view.graphics.removeAll();

            if (response.features.length > 0) {
              // Agregar gráficos al mapa
              response.features.forEach(function(feature) {
                const graphic = new Graphic({
                  geometry: feature.geometry,
                  symbol: {
                    type: "simple-marker",
                    style: "circle",
                    color: [0, 112, 255, 0.8],
                    size: "12px",
                    outline: {
                      color: "white",
                      width: 1
                    }
                  },
                  attributes: feature.attributes,
                  popupTemplate: {
                    title: "Fuente de Agua",
                    content: `
                      <div style="padding: 5px;">
                        <p><strong>Nombre:</strong> {NOMBRE}</p>
                        <p><strong>Dirección:</strong> {DIRECCION}</p>
                      </div>
                    `
                  }
                });
                view.graphics.add(graphic);
              });

              infoPanel.innerHTML = `
                <i class="fas fa-info-circle" style="color: #0070ff; margin-right: 5px;"></i>
                ${response.features.length} fuente(s) encontrada(s) en un radio de 500 metros.
              `;
            } else {
              infoPanel.innerHTML = `
                <i class="fas fa-exclamation-circle" style="color: #ff6b00; margin-right: 5px;"></i>
                No se encontraron fuentes de agua en un radio de 500 metros.
              `;
            }
          })
          .catch(function(error) {
            console.error("Error al ejecutar la consulta:", error);
            infoPanel.innerHTML = `
              <i class="fas fa-exclamation-triangle" style="color: #ff0000; margin-right: 5px;"></i>
              Error al consultar las fuentes de agua.
            `;
          });
      });
    });
  </script>
</body>
</html>